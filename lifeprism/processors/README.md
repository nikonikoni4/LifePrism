# æ•°æ®æ¸…æ´—æ¨¡å— - ç¼“å­˜å‘½ä¸­è§„åˆ™

æœ¬æ–‡æ¡£è¯´æ˜ `clean_activitywatch_data_v2` å‡½æ•°ä¸­çš„ç¼“å­˜å‘½ä¸­é€»è¾‘ã€‚

## æ¦‚è¿°

æ•°æ®æ¸…æ´—æµç¨‹ä¼šä» `category_map_cache` è¡¨åŠ è½½å·²æœ‰çš„åˆ†ç±»æ•°æ®ä½œä¸ºç¼“å­˜ã€‚å¯¹äºæ¯ä¸ªæ–°äº‹ä»¶ï¼Œç³»ç»Ÿä¼šå°è¯•ä»ç¼“å­˜ä¸­åŒ¹é…åˆ†ç±»ï¼Œé¿å…é‡å¤è°ƒç”¨ LLMã€‚

```
åŸå§‹äº‹ä»¶ â†’ EventTransformer â†’ CacheMatcher â†’ ClassifyCollector â†’ è¾“å‡º
                                   â†“
                            CategoryCache (ç¼“å­˜ç´¢å¼•)
```

---

## category_map_cache è¡¨çš„ä½œç”¨

`category_map_cache` è¡¨åœ¨æ•°æ®æ¸…æ´—æµç¨‹ä¸­æœ‰ä¸¤ä¸ªæ ¸å¿ƒä½œç”¨ï¼š

### ä½œç”¨ä¸€ï¼šåˆ†ç±»ç¼“å­˜

å­˜å‚¨å·²åˆ†ç±»åº”ç”¨çš„åˆ†ç±»ç»“æœï¼Œé¿å…é‡å¤è°ƒç”¨ LLM è¿›è¡Œåˆ†ç±»ã€‚

| åº”ç”¨ç±»å‹ | ç¼“å­˜æ¡ä»¶ | è¯´æ˜ |
|---------|---------|------|
| **å•ç”¨é€”åº”ç”¨** | `category_id IS NOT NULL` | æœ‰åˆ†ç±»å³å¯ç¼“å­˜ |
| **å¤šç”¨é€”åº”ç”¨** | `category_id IS NOT NULL` **ä¸”** `title IS NOT NULL` | å¿…é¡»åŒæ—¶æœ‰åˆ†ç±»å’Œ title æ‰èƒ½ç¼“å­˜ |

> ğŸ’¡ å¤šç”¨é€”åº”ç”¨ï¼ˆå¦‚æµè§ˆå™¨ï¼‰éœ€è¦ title æ¥åŒºåˆ†ä¸åŒçš„ä½¿ç”¨åœºæ™¯ï¼Œå› æ­¤æ—  title çš„è®°å½•æ— æ³•ä½œä¸ºæœ‰æ•ˆç¼“å­˜ã€‚

### ä½œç”¨äºŒï¼šåº”ç”¨æè¿°ç¼“å­˜

å­˜å‚¨é€šè¿‡ LLM æœç´¢è·å–çš„åº”ç”¨æè¿°ï¼ˆ`app_description`ï¼‰ï¼Œä¾›åç»­åˆ†ç±»æ—¶å¤ç”¨ã€‚

| ç‰¹æ€§ | è¯´æ˜ |
|-----|------|
| **ä¸åˆ†ç±»æ— å…³** | åªè¦æœ‰ `app_description` å°±å¯ä»¥å¤ç”¨ï¼Œå³ä½¿è¯¥è®°å½•æ²¡æœ‰åˆ†ç±» |
| **å¤šç”¨é€”å…±ç”¨** | åŒä¸€ä¸ª app çš„å¤šæ¡è®°å½•ï¼ˆä¸åŒ titleï¼‰å…±ç”¨ä¸€ä¸ªæè¿° |
| **å‡å°‘ LLM è°ƒç”¨** | æ–°äº‹ä»¶çš„ app å¦‚æœå·²æœ‰æè¿°ï¼Œæ— éœ€å†æ¬¡æœç´¢ |

```
ç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ app         â”‚ title            â”‚ app_description â”‚ category_id â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ msedge      â”‚ github.com       â”‚ å¾®è½¯æµè§ˆå™¨       â”‚ cat-work    â”‚  â† åˆ†ç±»ç¼“å­˜ âœ“ æè¿°ç¼“å­˜ âœ“
â”‚ msedge      â”‚ bilibili.com     â”‚ å¾®è½¯æµè§ˆå™¨       â”‚ cat-fun     â”‚  â† åˆ†ç±»ç¼“å­˜ âœ“ æè¿°å…±ç”¨ âœ“
â”‚ msedge      â”‚ new_page         â”‚ å¾®è½¯æµè§ˆå™¨       â”‚ NULL        â”‚  â† åˆ†ç±»ç¼“å­˜ âœ— æè¿°å…±ç”¨ âœ“
â”‚ new_app     â”‚ NULL             â”‚ NULL            â”‚ NULL        â”‚  â† åˆ†ç±»ç¼“å­˜ âœ— æè¿°ç¼“å­˜ âœ—
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç¼“å­˜æ„å»ºè§„åˆ™

### 1. å•ç”¨é€”åº”ç”¨ç¼“å­˜ (`_single_purpose_apps`)

**æ¡ä»¶**ï¼š`is_multipurpose_app == 0` **ä¸”** `category_id IS NOT NULL`

```
âœ… ç¼“å­˜: app=vscode, category_id=cat-work
âœ… ç¼“å­˜: app=postman, category_id=cat-work
âŒ ä¸ç¼“å­˜: app=notepad, category_id=NULL (æ— åˆ†ç±»)
```

### 2. å¤šç”¨é€”åº”ç”¨ç¼“å­˜ (`_multipurpose_apps` + `_multipurpose_titles`)

**æ¡ä»¶**ï¼š`is_multipurpose_app == 1` **ä¸”** `category_id IS NOT NULL` **ä¸”** `title IS NOT NULL`

```
âœ… ç¼“å­˜: app=msedge, title=github.com, category_id=cat-work
âœ… ç¼“å­˜: app=chrome, title=bilibili, category_id=cat-entertainment
âŒ ä¸ç¼“å­˜: app=msedge, title=NULL (æ—  title)
âŒ ä¸ç¼“å­˜: app=chrome, title=new_page, category_id=NULL (æ— åˆ†ç±»)
```

### 3. åº”ç”¨æè¿°ç¼“å­˜ (`_app_description_map`)

**æ¡ä»¶**ï¼š`app IS NOT NULL` **ä¸”** `app_description IS NOT NULL`

> âš ï¸ æè¿°ç¼“å­˜ **ä¸åˆ†ç±»æ— å…³**ï¼Œåªè¦æœ‰æè¿°å°±å¯ä»¥å¤ç”¨

```
âœ… å¤ç”¨: app=vscode, app_description="ä»£ç ç¼–è¾‘å™¨" (å³ä½¿æ— åˆ†ç±»)
âœ… å¤ç”¨: app=msedge, app_description="å¾®è½¯æµè§ˆå™¨"
âŒ ä¸å¤ç”¨: app=new_app, app_description=NULL
```

---

## ç¼“å­˜åŒ¹é…è§„åˆ™

### äº‹ä»¶ç±»å‹åˆ¤æ–­

```python
is_multipurpose = is_multipurpose_app(event.app)  # åŸºäºé…ç½®åˆ—è¡¨åˆ¤æ–­
```

### å•ç”¨é€”åº”ç”¨åŒ¹é…

```
åŒ¹é…æ¡ä»¶: app âˆˆ _single_purpose_apps
åŒ¹é…ç»“æœ: _app_category_map[app] â†’ (category_id, sub_category_id, link_to_goal_id)
```

| åœºæ™¯ | åŒ¹é…ç»“æœ | åç»­å¤„ç† |
|-----|---------|---------|
| app åœ¨ç¼“å­˜ä¸­ | âœ… HIT | ç›´æ¥ä½¿ç”¨ç¼“å­˜åˆ†ç±» |
| app ä¸åœ¨ç¼“å­˜ä¸­ | âŒ MISS | æ”¶é›†åˆ°å¾…åˆ†ç±»åˆ—è¡¨ |

### å¤šç”¨é€”åº”ç”¨åŒ¹é…

```
åŒ¹é…æ¡ä»¶: app âˆˆ _multipurpose_apps AND title âˆˆ _multipurpose_titles
åŒ¹é…ç»“æœ: _title_category_map[title] â†’ (category_id, sub_category_id, link_to_goal_id)
```

| åœºæ™¯ | åŒ¹é…ç»“æœ | åç»­å¤„ç† |
|-----|---------|---------|
| app + title éƒ½åœ¨ç¼“å­˜ä¸­ | âœ… HIT | ç›´æ¥ä½¿ç”¨ç¼“å­˜åˆ†ç±» |
| app åœ¨ç¼“å­˜ä½† title ä¸åœ¨ | âŒ MISS | æ”¶é›†åˆ°å¾…åˆ†ç±»åˆ—è¡¨ (æ–° title) |
| app ä¸åœ¨ç¼“å­˜ä¸­ | âŒ MISS | æ”¶é›†åˆ°å¾…åˆ†ç±»åˆ—è¡¨ (æ–° app) |

---

## å¾…åˆ†ç±»é¡¹æ”¶é›†è§„åˆ™

### å•ç”¨é€”åº”ç”¨

- **å»é‡è§„åˆ™**ï¼šæ¯ä¸ª app åªæ”¶é›†ä¸€æ¬¡
- **æè¿°å¤ç”¨**ï¼šä» `_app_description_map` è·å–å·²æœ‰æè¿°

```python
# ç¤ºä¾‹
if app not in seen_apps:
    app_registry[app] = AppInFo(
        description=cache.get_app_description(app),  # å¤ç”¨æè¿°
        is_multipurpose=False,
        titles=[title]
    )
    log_items.append(LogItem(app=app, title=title, ...))
```

### å¤šç”¨é€”åº”ç”¨

- **å»é‡è§„åˆ™**ï¼šæ¯ä¸ª title åªæ”¶é›†ä¸€æ¬¡ï¼ˆåŒä¸€ app å¯æœ‰å¤šä¸ª titleï¼‰
- **æè¿°å¤ç”¨**ï¼šä» `_app_description_map` è·å–å·²æœ‰æè¿°

```python
# ç¤ºä¾‹
if title not in seen_titles:
    if app not in app_registry:
        app_registry[app] = AppInFo(
            description=cache.get_app_description(app),  # å¤ç”¨æè¿°
            is_multipurpose=True,
            titles=[]
        )
    app_registry[app].titles.append(title)
    log_items.append(LogItem(app=app, title=title, ...))
```

---

## å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CategoryCache æ„å»º                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  category_map_cache_df                                          â”‚
â”‚         â”‚                                                       â”‚
â”‚         â”œâ”€â”€â”€ å•ç”¨é€” + æœ‰åˆ†ç±» â”€â”€â†’ _single_purpose_apps           â”‚
â”‚         â”‚                     â”€â”€â†’ _app_category_map             â”‚
â”‚         â”‚                                                       â”‚
â”‚         â”œâ”€â”€â”€ å¤šç”¨é€” + æœ‰åˆ†ç±» + æœ‰title â”€â”€â†’ _multipurpose_apps   â”‚
â”‚         â”‚                              â”€â”€â†’ _multipurpose_titles â”‚
â”‚         â”‚                              â”€â”€â†’ _title_category_map  â”‚
â”‚         â”‚                                                       â”‚
â”‚         â””â”€â”€â”€ æœ‰æè¿° â”€â”€â†’ _app_description_map (ä¸åˆ†ç±»æ— å…³)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      äº‹ä»¶å¤„ç†æµç¨‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ProcessedEvent                                                 â”‚
â”‚         â”‚                                                       â”‚
â”‚         â”œâ”€â”€â”€ is_multipurpose = False â”€â”€â”€â”                       â”‚
â”‚         â”‚                               â†“                       â”‚
â”‚         â”‚                    app âˆˆ _single_purpose_apps?        â”‚
â”‚         â”‚                         â”‚         â”‚                   â”‚
â”‚         â”‚                        YES       NO                   â”‚
â”‚         â”‚                         â†“         â†“                   â”‚
â”‚         â”‚                       HIT      MISS                   â”‚
â”‚         â”‚                    (ç”¨ç¼“å­˜)  (å¾…åˆ†ç±»)                  â”‚
â”‚         â”‚                                                       â”‚
â”‚         â””â”€â”€â”€ is_multipurpose = True â”€â”€â”€â”€â”                       â”‚
â”‚                                         â†“                       â”‚
â”‚                          app âˆˆ _multipurpose_apps               â”‚
â”‚                          AND title âˆˆ _multipurpose_titles?      â”‚
â”‚                                â”‚         â”‚                      â”‚
â”‚                               YES       NO                      â”‚
â”‚                                â†“         â†“                      â”‚
â”‚                              HIT      MISS                      â”‚
â”‚                           (ç”¨ç¼“å­˜)  (å¾…åˆ†ç±»)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | èŒè´£ |
|-----|------|
| `components/category_cache.py` | ç¼“å­˜ç´¢å¼•æ„å»ºä¸æŸ¥è¯¢ |
| `components/cache_matcher.py` | ç¼“å­˜åŒ¹é…ç­–ç•¥ |
| `components/classify_collector.py` | å¾…åˆ†ç±»é¡¹æ”¶é›† |
| `components/event_transformer.py` | äº‹ä»¶è½¬æ¢ä¸æ ‡å‡†åŒ– |
| `data_clean.py` | ä¸»å‡½æ•° `clean_activitywatch_data_v2` |
