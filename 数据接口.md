# Categorization Category Settings 接口设计

## 前端需求分析

根据 `CategorizationPage.tsx` 的分析，Category Settings 部分需要以下接口：

### 数据结构

#### 前端类型定义

```typescript
// L1 主分类
interface CategoryDef {
  id: string;
  name: string;
  color: string;
  subCategories: SubCategoryDef[];
}

// L2 子分类
interface SubCategoryDef {
  id: string;
  name: string;
}
```

### 前端需要的API接口

#### 1. 获取所有分类（GET）
- **功能**: 获取完整的分类层级结构
- **前端需求**: 页面初始化时加载所有分类数据
- **返回数据**: `CategoryDef[]`

#### 2. 创建主分类（POST）
- **功能**: 创建新的一级主分类
- **前端需求**: 用户点击 "Add New Category" 按钮
- **请求数据**: `{ name: string, color: string }`
- **返回数据**: 完整的 `CategoryDef` 对象（包含空的 subCategories）

#### 3. 更新主分类（PUT）
- **功能**: 重命名或修改主分类颜色
- **前端需求**: 用户编辑分类名称或颜色
- **请求数据**: `{ name?: string, color?: string }`
- **返回数据**: 更新后的 `CategoryDef` 对象

#### 4. 删除主分类（DELETE）
- **功能**: 删除主分类
- **前端需求**: 用户点击删除按钮
- **特殊处理**: 需要处理已关联该分类的活动记录（建议改为 'Uncategorized' 或级联删除）

#### 5. 添加子分类（POST）
- **功能**: 为指定主分类添加子分类
- **前端需求**: 用户在子分类输入框输入并点击 "Add" 按钮
- **请求数据**: `{ name: string }`（parentId 在 URL 路径中）
- **返回数据**: 新创建的 `SubCategoryDef` 对象

#### 6. 更新子分类（PUT）
- **功能**: 重命名子分类
- **前端需求**: 用户编辑子分类名称
- **请求数据**: `{ name: string }`
- **返回数据**: 更新后的 `SubCategoryDef` 对象

#### 7. 删除子分类（DELETE）
- **功能**: 删除子分类
- **前端需求**: 用户点击子分类的删除按钮
- **特殊处理**: 需要处理已关联该子分类的活动记录

---

## 后端数据库结构分析

### 当前数据库表

#### 1. `app_purpose_category` 表
用于存储应用程序的分类信息：

```python
{
    'app': TEXT PRIMARY KEY,              # 应用程序文件名
    'title': TEXT,                        # 应用程序标题
    'is_multipurpose_app': INTEGER,       # 是否为多用途应用
    'app_description': TEXT,              # 应用描述
    'title_description': TEXT,            # 标题描述
    'category': TEXT,             # 默认分类（工作/学习/其他）
    'sub_category': TEXT,               # 根据目标分类
    'created_at': TIMESTAMP,
    'updated_at': TIMESTAMP
}
```

#### 2. `user_app_behavior_log` 表
用于存储用户活动行为日志：

```python
{
    'id': TEXT PRIMARY KEY,               # 事件ID
    'timestamp': TEXT NOT NULL,           # 时间戳
    'duration': INTEGER,                  # 持续时间（秒）
    'app': TEXT NOT NULL,                 # 应用程序文件名
    'title': TEXT,                        # 窗口标题
    'category': TEXT,             # 默认分类
    'sub_category': TEXT,               # 目标分类
    'is_multipurpose_app': INTEGER,       # 是否多用途应用
    'created_at': TIMESTAMP
}
```

---

## 前后端数据映射与差异分析

### 主要差异

| 维度 | 前端需求 | 后端现状 | 兼容性 |
|------|----------|----------|--------|
| **分类层级** | 2层（主分类 + 子分类） | 1层（仅存储分类文本） | ❌ 不兼容 |
| **分类存储** | 独立的分类表 | 存储在应用分类字段中 | ❌ 不兼容 |
| **颜色属性** | 每个主分类有颜色 | 无颜色字段 | ❌ 不兼容 |
| **分类ID** | 使用唯一ID标识 | 使用分类名称 | ❌ 不兼容 |
| **分类结构** | 预定义的分类列表 | 动态分类文本 | ❌ 不兼容 |

### 具体问题

#### 1. **缺少分类定义表**
- **问题**: 后端没有独立的表来存储分类定义（主分类和子分类）
- **现状**: 分类信息直接以文本形式存储在 `category` 和 `sub_category` 字段中
- **影响**: 无法支持前端的分类CRUD操作

#### 2. **缺少颜色属性**
- **问题**: 前端需要为每个主分类设置颜色，但后端没有对应字段
- **影响**: 无法满足前端的颜色显示需求

#### 3. **分类层级结构不匹配**
- **问题**: 前端需要 2 层结构（主分类→子分类），后端只有扁平的文本字段
- **影响**: 无法表达层级关系

#### 4. **ID vs 名称**
- **问题**: 前端使用 ID 来引用分类，后端使用名称
- **影响**: 如果用户修改分类名称，所有历史记录的关联会断裂

---

## 后端实现方案

### 方案 1: 新建分类定义表（推荐）

#### 新增数据表

##### 1. `category` 表（主分类）

```python
CATEGORY_CONFIG = {
    'table_name': 'category',
    'columns': {
        'id': {
            'type': 'TEXT',
            'constraints': ['PRIMARY KEY'],
            'comment': '分类唯一标识符'
        },
        'name': {
            'type': 'TEXT',
            'constraints': ['NOT NULL'],
            'comment': '分类名称'
        },
        'color': {
            'type': 'TEXT',
            'constraints': ['NOT NULL'],
            'comment': '分类颜色（十六进制）'
        },
        'order_index': {
            'type': 'INTEGER',
            'constraints': ['DEFAULT 0'],
            'comment': '显示顺序'
        }
    },
    'table_constraints': [],
    'indexes': [
        {'name': 'idx_category_id', 'columns': ['id']}
    ],
    'timestamps': True
}
```

##### 2. `sub_category` 表（子分类）

```python
SUB_CATEGORY_CONFIG = {
    'table_name': 'sub_category',
    'columns': {
        'id': {
            'type': 'TEXT',
            'constraints': ['PRIMARY KEY'],
            'comment': '子分类唯一标识符'
        },
        'category_id': {
            'type': 'TEXT',
            'constraints': ['NOT NULL'],
            'comment': '所属主分类ID'
        },
        'name': {
            'type': 'TEXT',
            'constraints': ['NOT NULL'],
            'comment': '子分类名称'
        },
        'order_index': {
            'type': 'INTEGER',
            'constraints': ['DEFAULT 0'],
            'comment': '显示顺序'
        }
    },
    'table_constraints': [
        'FOREIGN KEY (category_id) REFERENCES category(id) ON DELETE CASCADE'
    ],
    'indexes': [
        {'name': 'idx_sub_category_id', 'columns': ['id']},
        {'name': 'idx_sub_category_parent', 'columns': ['category_id']}
    ],
    'timestamps': True
}
```

#### 修改现有表

需要将 `user_app_behavior_log` 表的字段改为引用新的分类表：

```python
# 添加新字段
'category_id': {
    'type': 'TEXT',
    'constraints': [],
    'comment': '主分类ID（外键引用 category.id）'
},
'sub_category_id': {
    'type': 'TEXT',
    'constraints': [],
    'comment': '子分类ID（外键引用 sub_category.id）'
}

# 保留旧字段用于数据迁移，后续可删除
# 'category': TEXT
# 'sub_category': TEXT
```

### 方案 2: 使用 JSON 字段（简化方案）

如果不想新增表，可以在现有配置中添加一个 JSON 字段来存储分类配置：

```python
# 添加到某个配置表中
'category_definitions': {
    'type': 'TEXT',  # 存储 JSON 字符串
    'constraints': [],
    'comment': '分类定义（JSON格式）'
}
```

**优点**: 实现简单，不需要多表关联  
**缺点**: 查询和维护不便，不符合关系型数据库设计原则

---

## 接口实现评估

### ✅ 后端可以实现的功能

使用**方案1（新建表）**，所有前端需求都可以实现：

1. ✅ **GET 获取所有分类**: 联表查询 `category` 和 `sub_category`
2. ✅ **POST 创建主分类**: 插入 `category` 表
3. ✅ **PUT 更新主分类**: 更新 `category` 表
4. ✅ **DELETE 删除主分类**: 删除 `category` 表（级联删除子分类）
5. ✅ **POST 添加子分类**: 插入 `sub_category` 表
6. ✅ **PUT 更新子分类**: 更新 `sub_category` 表
7. ✅ **DELETE 删除子分类**: 删除 `sub_category` 表

### ⚠️ 需要额外处理的问题

#### 1. 数据迁移
- 需要将现有的 `category` 和 `sub_category` 文本数据迁移到新的分类表
- 创建默认分类（Work, Entertainment, Other）

#### 2. 级联处理
- 删除主分类时，需要重新分配所有关联的活动记录
- 可选方案：
  - 移动到 "Uncategorized" 分类
  - 级联删除所有活动记录（不推荐）
  - 阻止删除（如果有关联记录）

#### 3. 后端API层实现
需要在 `lifewatch/server` 目录下实现：
- Category Service (业务逻辑层)
- Category Router (API路由层)
- Category Schema (数据验证层)

---

## 建议实现步骤

### 阶段1: 数据库设计
1. ✅ 在 `lifewatch/config/database.py` 中添加 `CATEGORY_CONFIG` 和 `SUB_CATEGORY_CONFIG`
2. ✅ 修改 `user_app_behavior_log` 表配置，添加 `category_id` 和 `sub_category_id` 字段
3. ✅ 运行数据库迁移，创建新表

### 阶段2: 数据迁移
1. ✅ 创建默认分类数据（Work, Entertainment, Other）
2. ✅ 创建默认子分类数据（Coding, Meeting, etc.）
3. ✅ 迁移现有的 `category` 数据到新的分类ID

### 阶段3: 后端服务实现
1. ✅ 实现 Category Service (CRUD操作)
2. ✅ 实现 Category Router (API端点)
3. ✅ 实现数据验证 Schema

### 阶段4: 前后端联调
1. ⏳ 前端调用新的API接口
2. ⏳ 测试所有CRUD操作
3. ⏳ 测试级联删除逻辑

---

## 已实现的 API 接口文档

### 基础信息

- **Base URL**: `http://127.0.0.1:8000`
- **API 文档**: `http://127.0.0.1:8000/docs` (Swagger UI)
- **API Prefix**: `/api/categories`

### 接口列表

#### 1. GET /api/categories - 获取所有分类

**描述**: 获取完整的分类层级结构，包含所有主分类及其子分类

**请求**:
```http
GET /api/categories HTTP/1.1
Host: 127.0.0.1:8000
```

**响应** (200 OK):
```json
{
  "categories": [
    {
      "id": "work",
      "name": "工作/学习",
      "color": "#5B8FF9",
      "subCategories": [
        { "id": "coding", "name": "Coding" },
        { "id": "meeting", "name": "Meetings" },
        { "id": "planning", "name": "Planning" },
        { "id": "research", "name": "Research" }
      ]
    },
    {
      "id": "entertainment",
      "name": "生活/娱乐",
      "color": "#FA8C16",
      "subCategories": [
        { "id": "video", "name": "Video Streaming" },
        { "id": "games", "name": "Gaming" },
        { "id": "social", "name": "Social Media" }
      ]
    },
    {
      "id": "other",
      "name": "其他",
      "color": "#BFBFBF",
      "subCategories": [
        { "id": "utilities", "name": "System Utilities" },
        { "id": "browsing", "name": "General Browsing" },
        { "id": "untracked", "name": "Untracked" }
      ]
    }
  ]
}
```

---

#### 2. POST /api/categories - 创建主分类

**描述**: 创建新的主分类

**请求**:
```http
POST /api/categories HTTP/1.1
Host: 127.0.0.1:8000
Content-Type: application/json

{
  "name": "学习",
  "color": "#34D399"
}
```

**请求参数**:
- `name` (string, required): 分类名称，1-50字符
- `color` (string, required): 分类颜色，十六进制格式（如 `#5B8FF9`）

**响应** (200 OK):
```json
{
  "id": "cat-a1b2c3d4",
  "name": "学习",
  "color": "#34D399",
  "subCategories": []
}
```

**错误响应** (500):
```json
{
  "detail": "创建分类失败: <错误信息>"
}
```

---

#### 3. PUT /api/categories/{category_id} - 更新主分类

**描述**: 更新主分类的名称或颜色

**请求**:
```http
PUT /api/categories/work HTTP/1.1
Host: 127.0.0.1:8000
Content-Type: application/json

{
  "name": "工作",
  "color": "#5B8FF9"
}
```

**路径参数**:
- `category_id` (string, required): 分类ID

**请求参数**:
- `name` (string, optional): 新的分类名称
- `color` (string, optional): 新的分类颜色

**响应** (200 OK):
```json
{
  "id": "work",
  "name": "工作",
  "color": "#5B8FF9",
  "subCategories": [...]
}
```

**错误响应**:
- 404: 分类不存在
- 500: 更新失败

---

#### 4. DELETE /api/categories/{category_id} - 删除主分类

**描述**: 删除主分类，自动级联删除所有子分类，关联的活动记录会被重新分配到 'other' 分类

**请求**:
```http
DELETE /api/categories/work HTTP/1.1
Host: 127.0.0.1:8000
```

**路径参数**:
- `category_id` (string, required): 分类ID

**响应** (200 OK):
```json
{
  "success": true,
  "data": {
    "deleted": true
  },
  "message": "分类 'work' 删除成功"
}
```

**错误响应**:
- 404: 分类不存在
- 500: 删除失败

**注意事项**:
- 会自动删除该分类下的所有子分类（CASCADE）
- 关联的 `user_app_behavior_log` 记录会被重新分配到 `other` 分类

---

#### 5. POST /api/categories/{parent_id}/sub - 添加子分类

**描述**: 为指定主分类添加子分类

**请求**:
```http
POST /api/categories/work/sub HTTP/1.1
Host: 127.0.0.1:8000
Content-Type: application/json

{
  "name": "编程"
}
```

**路径参数**:
- `parent_id` (string, required): 主分类ID

**请求参数**:
- `name` (string, required): 子分类名称，1-50字符

**响应** (200 OK):
```json
{
  "id": "sub-e5f6g7h8",
  "name": "编程"
}
```

**错误响应**:
- 404: 主分类不存在
- 500: 创建失败

---

#### 6. PUT /api/categories/{parent_id}/sub/{sub_id} - 更新子分类

**描述**: 更新子分类名称

**请求**:
```http
PUT /api/categories/work/sub/coding HTTP/1.1
Host: 127.0.0.1:8000
Content-Type: application/json

{
  "name": "代码审查"
}
```

**路径参数**:
- `parent_id` (string, required): 主分类ID
- `sub_id` (string, required): 子分类ID

**请求参数**:
- `name` (string, required): 新的子分类名称

**响应** (200 OK):
```json
{
  "id": "coding",
  "name": "代码审查"
}
```

**错误响应**:
- 404: 主分类或子分类不存在，或子分类不属于该主分类
- 500: 更新失败

---

#### 7. DELETE /api/categories/{parent_id}/sub/{sub_id} - 删除子分类

**描述**: 删除子分类，关联的活动记录会被重新分配到 'untracked' 子分类

**请求**:
```http
DELETE /api/categories/work/sub/coding HTTP/1.1
Host: 127.0.0.1:8000
```

**路径参数**:
- `parent_id` (string, required): 主分类ID
- `sub_id` (string, required): 子分类ID

**响应** (200 OK):
```json
{
  "success": true,
  "data": {
    "deleted": true
  },
  "message": "子分类 'coding' 删除成功"
}
```

**错误响应**:
- 404: 主分类或子分类不存在
- 500: 删除失败

**注意事项**:
- 关联的 `user_app_behavior_log` 记录会被重新分配到 `untracked` 子分类

---

## 数据库实现细节

### 已创建的表

#### 1. category 表
```sql
CREATE TABLE category (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    color TEXT NOT NULL,
    order_index INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2. sub_category 表
```sql
CREATE TABLE sub_category (
    id TEXT PRIMARY KEY,
    category_id TEXT NOT NULL,
    name TEXT NOT NULL,
    order_index INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (category_id) REFERENCES category(id) ON DELETE CASCADE
);
```

#### 3. user_app_behavior_log 表（新增字段）
```sql
ALTER TABLE user_app_behavior_log ADD COLUMN category_id TEXT;
ALTER TABLE user_app_behavior_log ADD COLUMN sub_category_id TEXT;
```

### 默认数据

系统已初始化以下默认数据：

**主分类**:
- `work` - 工作/学习 - #5B8FF9
- `entertainment` - 生活/娱乐 - #FA8C16
- `other` - 其他 - #BFBFBF

**子分类**:
- Work: `coding`, `meeting`, `planning`, `research`
- Entertainment: `video`, `games`, `social`
- Other: `utilities`, `browsing`, `untracked`

---

## 总结

### 实现状态

| 功能 | 状态 | 说明 |
|------|------|------|
| 数据库设计 | ✅ 完成 | 已创建 category 和 sub_category 表 |
| 默认数据初始化 | ✅ 完成 | 3个主分类，10个子分类 |
| Schema 层 | ✅ 完成 | Pydantic 模型验证 |
| Service 层 | ✅ 完成 | 完整的 CRUD 业务逻辑 |
| API Router 层 | ✅ 完成 | 7 个 REST 端点 |
| 级联删除处理 | ✅ 完成 | 自动重新分配孤立记录 |
| 前端集成 | ⏳ 待测试 | 需要前端连接后端测试 |

### 问题已解决

- ✅ **分类定义表**: 已创建独立的 category 和 sub_category 表
- ✅ **分类层级结构**: 支持两层结构（主分类→子分类）
- ✅ **颜色属性**: 主分类包含颜色字段
- ✅ **ID 标识**: 使用唯一 ID 代替名称引用
- ✅ **级联处理**: 删除时自动处理孤立记录

### 技术栈

- **后端框架**: FastAPI
- **数据库**: SQLite
- **ORM**: 自定义 DatabaseManager
- **数据验证**: Pydantic V2
- **API 文档**: Swagger UI (自动生成)

### 下一步建议

1. **前端集成测试**
   - 连接前端到 `http://127.0.0.1:8000`
   - 测试所有 CRUD 操作
   - 验证 UI 交互

2. **数据迁移**（如有需要）
   - 将旧的 `category` 数据映射到新的分类 ID
   - 编写迁移脚本

3. **性能优化**（可选）
   - 添加分类数据缓存
   - 优化数据库查询

4. **安全性增强**（可选）
   - 添加认证授权
   - 输入数据清理和验证

---

## 快速开始

### 启动服务器
```bash
cd lifewatch/server
uvicorn main:app --reload
```

### 访问 API 文档
浏览器打开: http://127.0.0.1:8000/docs

### 测试 API
```bash
# 获取所有分类
curl http://127.0.0.1:8000/api/categories

# 创建新分类
curl -X POST http://127.0.0.1:8000/api/categories \
  -H "Content-Type: application/json" \
  -d '{"name":"学习","color":"#34D399"}'
```

